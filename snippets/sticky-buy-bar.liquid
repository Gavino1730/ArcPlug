{% comment %}
  Sticky Mobile Buy Bar
  Keeps CTA visible while scrolling on mobile devices
{% endcomment %}

<div class="sticky-buy-bar" id="stickyBuyBar" style="display: none;">
  <style>
    .sticky-buy-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgb(var(--color-background));
      border-top: 1px solid rgba(var(--color-border), 0.2);
      padding: 0.75rem 1rem;
      box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1), 0 -2px 4px -1px rgba(0, 0, 0, 0.06);
      z-index: 999;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }
    
    .sticky-buy-bar.visible {
      transform: translateY(0);
    }
    
    .sticky-buy-content {
      display: flex;
      align-items: center;
      gap: 1rem;
      max-width: 100%;
    }
    
    .sticky-product-info {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }
    
    .sticky-product-image {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 0.5rem;
      flex-shrink: 0;
    }
    
    .sticky-product-details {
      flex: 1;
      min-width: 0;
    }
    
    .sticky-product-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: rgb(var(--color-foreground));
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      margin: 0;
    }
    
    .sticky-product-price {
      font-size: 1rem;
      font-weight: 700;
      color: rgb(var(--color-foreground));
      margin: 0;
    }
    
    .sticky-buy-button {
      flex-shrink: 0;
      background: linear-gradient(135deg, #6366f1, #a855f7);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      white-space: nowrap;
    }
    
    .sticky-buy-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.3);
    }
    
    .sticky-buy-button:active {
      transform: translateY(0);
    }
    
    .sticky-buy-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    @media screen and (min-width: 750px) {
      .sticky-buy-bar {
        display: none !important;
      }
    }
    
    @media screen and (max-width: 749px) {
      body.has-sticky-bar {
        padding-bottom: 80px;
      }
    }
  </style>
  
  <div class="sticky-buy-content">
    <div class="sticky-product-info">
      {% if product.featured_image %}
        <img 
          class="sticky-product-image" 
          src="{{ product.featured_image | image_url: width: 100 }}" 
          alt="{{ product.title | escape }}"
          width="50"
          height="50"
          loading="lazy"
        >
      {% endif %}
      <div class="sticky-product-details">
        <h3 class="sticky-product-title">{{ product.title | escape }}</h3>
        <div class="sticky-product-price" id="stickyPrice">
          {{ product.selected_or_first_available_variant.price | money }}
        </div>
      </div>
    </div>
    <button 
      type="button" 
      class="sticky-buy-button" 
      id="stickyAddToCart"
      {% unless product.selected_or_first_available_variant.available %}disabled{% endunless %}
    >
      {% if product.selected_or_first_available_variant.available %}
        Add to Cart
      {% else %}
        Sold Out
      {% endif %}
    </button>
  </div>
</div>

<script>
  (function() {
    const stickyBar = document.getElementById('stickyBuyBar');
    const stickyButton = document.getElementById('stickyAddToCart');
    const stickyPrice = document.getElementById('stickyPrice');
    
    // Show/hide sticky bar based on scroll position
    let lastScroll = 0;
    const mainAddToCart = document.querySelector('.product-form__submit');
    
    if (mainAddToCart && stickyBar && window.innerWidth < 750) {
      stickyBar.style.display = 'block';
      
      const observer = new IntersectionObserver(
        ([entry]) => {
          if (entry.isIntersecting) {
            stickyBar.classList.remove('visible');
            document.body.classList.remove('has-sticky-bar');
          } else {
            stickyBar.classList.add('visible');
            document.body.classList.add('has-sticky-bar');
          }
        },
        { threshold: 0, rootMargin: '0px 0px -80px 0px' }
      );
      
      observer.observe(mainAddToCart);
      
      // Sync with main form
      stickyButton.addEventListener('click', function() {
        if (mainAddToCart && !mainAddToCart.disabled) {
          mainAddToCart.click();
          
          // Visual feedback
          this.textContent = 'âœ“ Added!';
          setTimeout(() => {
            this.textContent = 'Add to Cart';
          }, 2000);
        }
      });
      
      // Update price when variant changes
      document.addEventListener('variant:changed', function(event) {
        if (event.detail && event.detail.variant) {
          const variant = event.detail.variant;
          if (stickyPrice && variant.price) {
            stickyPrice.textContent = Shopify.formatMoney(variant.price, theme.moneyFormat || '${{amount}}');
          }
          if (stickyButton) {
            stickyButton.disabled = !variant.available;
            stickyButton.textContent = variant.available ? 'Add to Cart' : 'Sold Out';
          }
        }
      });
    }
  })();
</script>
